# Deployment Guide

This guide will help you deploy the Shopify Tags Management System to a production server.

## Prerequisites

- PHP 8.2 or higher
- MySQL 5.7+ or MariaDB 10.3+
- Composer
- Node.js & NPM
- Git
- Web server (Apache/Nginx)

## Option 1: VPS/Shared Hosting Deployment

### Step 1: Upload Files to Server

#### Using Git (Recommended):
```bash
# SSH into your server
ssh user@your-server.com

# Navigate to web root
cd /var/www/html  # or your web root directory

# Clone the repository
git clone git@github.com:aviadmols/ZygAPi.git shopify-tags
cd shopify-tags

# Or if you already have the files, pull latest changes
git pull origin master
```

#### Using FTP/SFTP:
1. Upload all files to your server's web root directory
2. Make sure hidden files (starting with `.`) are uploaded

### Step 2: Install Dependencies

```bash
# Install PHP dependencies
composer install --optimize-autoloader --no-dev

# Install Node dependencies
npm install

# Build assets
npm run build
```

### Step 3: Configure Environment

```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate
```

Edit `.env` file with your production settings:

```env
APP_NAME="Shopify Tags System"
APP_ENV=production
APP_KEY=base64:...  # Generated by key:generate
APP_DEBUG=false
APP_URL=https://your-domain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database_name
DB_USERNAME=your_database_user
DB_PASSWORD=your_database_password

QUEUE_CONNECTION=database  # or redis if available

OPENROUTER_API_KEY=your_openrouter_api_key
SHOPIFY_WEBHOOK_SECRET=your_webhook_secret

SESSION_DRIVER=database
CACHE_STORE=database
```

### Step 4: Set Permissions

```bash
# Set proper permissions
chmod -R 755 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache  # Adjust user/group as needed
```

### Step 5: Run Migrations

```bash
# Run database migrations
php artisan migrate --force

# (Optional) Seed database if needed
# php artisan db:seed
```

### Step 6: Configure Web Server

#### Apache Configuration

Ensure your `.htaccess` file in the `public` directory exists:

```apache
<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
</IfModule>
```

Point your Apache virtual host to the `public` directory:

```apache
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /var/www/html/shopify-tags/public

    <Directory /var/www/html/shopify-tags/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/shopify-tags-error.log
    CustomLog ${APACHE_LOG_DIR}/shopify-tags-access.log combined
</VirtualHost>
```

#### Nginx Configuration

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/html/shopify-tags/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

### Step 7: Set Up Queue Worker

Create a systemd service for the queue worker:

```bash
sudo nano /etc/systemd/system/shopify-tags-queue.service
```

Add the following content:

```ini
[Unit]
Description=Shopify Tags Queue Worker
After=network.target

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/html/shopify-tags/artisan queue:work --queue=order-processing --sleep=3 --tries=3 --max-time=3600

[Install]
WantedBy=multi-user.target
```

Enable and start the service:

```bash
sudo systemctl enable shopify-tags-queue.service
sudo systemctl start shopify-tags-queue.service
sudo systemctl status shopify-tags-queue.service
```

### Step 8: Set Up Cron Job

Add Laravel's scheduler to crontab:

```bash
crontab -e
```

Add this line:

```
* * * * * cd /var/www/html/shopify-tags && php artisan schedule:run >> /dev/null 2>&1
```

### Step 9: Optimize for Production

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

## Option 2: Cloud Platform Deployment

### Railway

1. Install Railway CLI:
```bash
npm install -g @railway/cli
# OR
brew install railway
```

2. Login and initialize:
```bash
railway login
railway init
```

3. Set environment variables (see `RAILWAY_DEPLOY.md` for full list)

4. Deploy:
```bash
railway up
```

5. Run migrations:
```bash
railway run php artisan migrate --force
```

6. Add Worker service for queue processing in Railway dashboard

See `RAILWAY_DEPLOY.md` for detailed Railway deployment instructions.

### Heroku

1. Install Heroku CLI
2. Create `Procfile`:
```
web: vendor/bin/heroku-php-apache2 public/
worker: php artisan queue:work --queue=order-processing --sleep=3 --tries=3
```

3. Deploy:
```bash
heroku create your-app-name
git push heroku main
heroku run php artisan migrate --force
```

### DigitalOcean App Platform

1. Connect your GitHub repository
2. Configure build settings:
   - Build Command: `composer install --optimize-autoloader --no-dev && npm install && npm run build`
   - Run Command: `php artisan serve --host=0.0.0.0 --port=8080`
3. Add environment variables in the dashboard
4. Add a worker component for queue processing

### AWS EC2 / Lightsail

Follow Option 1 (VPS Deployment) instructions.

## Post-Deployment Checklist

- [ ] Environment variables configured correctly
- [ ] Database migrations run successfully
- [ ] Storage and cache directories have proper permissions
- [ ] Queue worker is running
- [ ] Cron job is set up
- [ ] SSL certificate installed (HTTPS)
- [ ] Webhook URL configured in Shopify
- [ ] Test order processing functionality
- [ ] Test AI conversation feature
- [ ] Monitor logs for errors

## Troubleshooting

### Queue Not Processing

```bash
# Check queue worker status
sudo systemctl status shopify-tags-queue.service

# View queue logs
tail -f storage/logs/laravel.log

# Restart queue worker
sudo systemctl restart shopify-tags-queue.service
```

### Permission Issues

```bash
# Fix storage permissions
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### Clear All Caches

```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear
```

### Database Connection Issues

- Verify database credentials in `.env`
- Check database server is running
- Ensure database user has proper permissions
- Test connection: `php artisan tinker` then `DB::connection()->getPdo();`

## Security Considerations

1. **Never commit `.env` file** - It contains sensitive information
2. **Set `APP_DEBUG=false`** in production
3. **Use HTTPS** - Configure SSL certificate
4. **Restrict file permissions** - Only web server user should have write access
5. **Keep dependencies updated** - Regularly run `composer update` and `npm update`
6. **Monitor logs** - Check `storage/logs/laravel.log` regularly
7. **Use strong passwords** - For database and all accounts
8. **Enable firewall** - Only allow necessary ports (80, 443, 22)

## Monitoring

### Log Files

- Application logs: `storage/logs/laravel.log`
- Web server logs: Check Apache/Nginx log directories
- Queue logs: Included in `laravel.log`

### Health Check Endpoint

You can create a simple health check route in `routes/web.php`:

```php
Route::get('/health', function () {
    return response()->json([
        'status' => 'ok',
        'timestamp' => now(),
        'queue' => DB::table('jobs')->count(),
    ]);
});
```

## Support

For issues or questions, check the main README.md file or create an issue on GitHub.
